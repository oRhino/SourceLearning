#AFNetWorkingæºç ä¹‹AFURLRequestSerialization
##ç®€ä»‹
AFURLRequestSerializationå¯ä»¥ç†è§£æˆè¯·æ±‚åºåˆ—åŒ–çš„ä¸€ä¸ªæŠ½è±¡,ä¸»è¦ç›®åœ°æ˜¯ç”Ÿæˆä¸€ä¸ªNSURLRequestçš„è¯·æ±‚å¯¹è±¡,ç”¨äºå‘é€è¯·æ±‚.AFHTTPRequestSerializeréµå¾ªè¯¥æ¥å£,å®ç°äº†æ„å»ºå‘èµ·HTTPè¯·æ±‚å¯¹è±¡çš„åŠŸèƒ½,æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»AFHTTPRequestSerializer.
å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹:

1. é…ç½®ç›¸å…³NSMutableURLRequestçš„å±æ€§(æ¯”å¦‚,è¯·æ±‚å¤´,ç¼“å­˜ç­–ç•¥,cookies,è¶…æ—¶æ—¶é—´ç­‰)
2. å¯¹URLè¿›è¡Œäº†PercentCode(ç™¾åˆ†æ¯”ç¼–ç )æˆ–è€…ç§°ä¹‹ä¸ºè½¬ä¹‰ 
3. æ ¹æ®ä¸åŒçš„è¯·æ±‚æ–¹å¼æ ¼å¼åŒ–è¯·æ±‚å‚æ•°
4. multipart/from-dataæ–¹å¼æ–‡ä»¶ä¸Šä¼ çš„ç®€åŒ–å¤„ç†

##é…ç½®è¯·æ±‚å‚æ•°
#####æ˜¯å¦å…è®¸ä½¿ç”¨è®¾å¤‡çš„èœ‚çªç§»åŠ¨ç½‘ç»œæ¥åˆ›å»ºrequestï¼Œé»˜è®¤ä¸ºå…è®¸:

```
 @property (nonatomic, assign) BOOL allowsCellularAccess;
```
#####ç¼“å­˜ç­–ç•¥ é»˜è®¤ä½¿ç”¨`NSURLRequestUseProtocolCachePolicy`
NSURLRequestCachePolicyæ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹

-  NSURLRequestUseProtocolCachePolicy      è¿™ä¸ªæ˜¯é»˜è®¤çš„ç¼“å­˜ç­–ç•¥ï¼Œç¼“å­˜ä¸å­˜åœ¨ï¼Œå°±è¯·æ±‚æœåŠ¡å™¨ï¼Œç¼“å­˜å­˜åœ¨ï¼Œä¼šæ ¹æ®responseä¸­çš„Cache-Controlå­—æ®µåˆ¤æ–­ä¸‹ä¸€æ­¥æ“ä½œï¼Œå¦‚: Cache-Controlå­—æ®µä¸ºmust-revalidata, åˆ™è¯¢é—®æœåŠ¡ç«¯è¯¥æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ï¼Œæ— æ›´æ–°çš„è¯ç›´æ¥è¿”å›ç»™ç”¨æˆ·ç¼“å­˜æ•°æ®ï¼Œè‹¥å·²æ›´æ–°ï¼Œåˆ™è¯·æ±‚æœåŠ¡ç«¯ã€‚
- NSURLRequestReloadIgnoringLocalCacheData   è¿™ä¸ªç­–ç•¥æ˜¯ä¸ç®¡æœ‰æ²¡æœ‰æœ¬åœ°ç¼“å­˜ï¼Œéƒ½è¯·æ±‚æœåŠ¡å™¨ã€‚
- NSURLRequestReloadIgnoringLocalAndRemoteCacheData   è¿™ä¸ªç­–ç•¥ä¼šå¿½ç•¥æœ¬åœ°ç¼“å­˜å’Œä¸­é—´ä»£ç† ç›´æ¥è®¿é—®æºserver
- NSURLRequestReturnCacheDataElseLoad    è¿™ä¸ªç­–ç•¥æŒ‡ï¼Œæœ‰ç¼“å­˜å°±æ˜¯ç”¨ï¼Œä¸ç®¡å…¶æœ‰æ•ˆæ€§ï¼Œå³Cache-Controlå­—æ®µ ï¼Œæ²¡æœ‰å°±è®¿é—®æºserver
- NSURLRequestReturnCacheDataDontLoad   è¿™ä¸ªç­–ç•¥åªåŠ è½½æœ¬åœ°æ•°æ®ï¼Œä¸åšå…¶ä»–æ“ä½œï¼Œé€‚ç”¨äºæ²¡æœ‰ç½‘è·¯çš„æƒ…å†µ
- NSURLRequestReloadRevalidatingCacheData  è¿™ä¸ªç­–ç•¥æ ‡ç¤ºç¼“å­˜æ•°æ®å¿…é¡»å¾—åˆ°æœåŠ¡å™¨ç¡®è®¤æ‰èƒ½ä½¿ç”¨ï¼Œæœªå®ç°ã€‚

```
@property (nonatomic, assign) NSURLRequestCachePolicy cachePolicy;
```
#####HTTPShouldHandleCookieså¸ƒå°”ç±»å‹,é»˜è®¤YES
å¦‚æœè®¾ç½®HTTPShouldHandleCookiesä¸ºYESï¼Œå°±å¤„ç†å­˜å‚¨åœ¨NSHTTPCookieStoreä¸­çš„cookies
 HTTPShouldHandleCookiesè¡¨ç¤ºæ˜¯å¦åº”è¯¥ç»™requestè®¾ç½®cookieå¹¶éšrequestä¸€èµ·å‘é€å‡ºå»

```
@property (nonatomic, assign) BOOL HTTPShouldHandleCookies;
```
#####HTTPShouldUsePipelining å¸ƒå°”ç±»å‹ é»˜è®¤NO
 HTTPShouldUsePipeliningè¡¨ç¤ºå®¢æˆ·ç«¯çš„ä¸‹ä¸€ä¸ªä¿¡æ¯æ˜¯å¦å¿…é¡»ç­‰åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚å›å¤æ‰èƒ½å‘é€ã€‚
 å¦‚æœä¸ºYESè¡¨ç¤ºå¯ä»¥ï¼ŒNOè¡¨ç¤ºå¿…é¡»ç­‰å®¢æˆ·ç«¯æ”¶åˆ°å…ˆå‰çš„å›å¤æ‰èƒ½å‘é€ä¸‹ä¸ªä¿¡æ¯ã€‚
 åœ¨HTTPè¿æ¥ä¸­ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªè¿æ¥ï¼Œæ¯æ¬¡å»ºç«‹TCPè¿æ¥æ˜¯éœ€è¦ä¸€å®šæ—¶é—´çš„ã€‚ç®¡çº¿åŒ–ï¼Œå…è®¸ä¸€æ¬¡å‘é€ä¸€ç»„è¯·æ±‚è€Œä¸å¿…ç­‰åˆ°å“åº”ã€‚ä½†ç”±äºç›®å‰å¹¶ä¸æ˜¯æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½æ”¯æŒè¿™é¡¹åŠŸèƒ½ï¼Œå› æ­¤è¿™ä¸ªå±æ€§é»˜è®¤æ˜¯ä¸å¼€å¯çš„ã€‚ç®¡çº¿åŒ–ä½¿ç”¨åŒä¸€TCPè¿æ¥å®Œæˆä»»åŠ¡ï¼Œå› æ­¤èƒ½å¤Ÿå¤§å¤§èŠ‚çœæäº¤è¯·æ±‚çš„æ—¶é—´ã€‚ä½†æ˜¯å“åº”è¦å’Œè¯·æ±‚çš„é¡ºåº ä¿æŒä¸€è‡´æ‰è¡Œã€‚ä½¿ç”¨åœºæ™¯:æ¯”å¦‚è¯´é¦–é¡µè¦å‘é€å¾ˆå¤šè¯·æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è¿™ç§æŠ€æœ¯ã€‚ä½†å‰ææ˜¯å»ºç«‹è¿æ¥æˆåŠŸåæ‰å¯ä»¥ä½¿ç”¨ã€‚
 
 ```
 @property (nonatomic, assign) BOOL HTTPShouldUsePipelining;
 ```
 
##### ç½‘ç»œæœåŠ¡ç±»å‹ 
æšä¸¾:é»˜è®¤NSURLNetworkServiceTypeDefault

```
@property (nonatomic, assign) NSURLRequestNetworkServiceType networkServiceType;
```
##### 	è¯·æ±‚è¶…æ—¶æ—¶é—´ 60s

```
@property (nonatomic, assign) NSTimeInterval timeoutInterval;
```
##### è¯·æ±‚å¤´

```
//è¯·æ±‚å¤´ é»˜è®¤åŒ…å« 'Accept-Language':[NSLocale preferredLanguages]
//              'User-Agent':
@property (readonly, nonatomic, strong) NSDictionary <NSString *, NSString *> *HTTPRequestHeaders;
//è®¾ç½®è¯·æ±‚å¤´
- (void)setValue:(nullable NSString *)value
forHTTPHeaderField:(NSString *)field;
//è·å–è¯·æ±‚å¤´ä¿¡æ¯
- (nullable NSString *)valueForHTTPHeaderField:(NSString *)field;
```
##### å‡­è¯

```
//è®¾ç½®å‡­è¯
- (void)setAuthorizationHeaderFieldWithUsername:(NSString *)username
                                       password:(NSString *)password;
 //æ¸…é™¤å‡­è¯
- (void)clearAuthorizationHeader;
```

å¯¹äºè¯·æ±‚å¤´ç›¸å…³çš„è®¾ç½®,AFHTTPRequestSerializeråˆ›å»ºäº†requestHeaderModificationQueueè¿™ä¸ªå¹¶è¡Œé˜Ÿåˆ—,ç”¨äºè®¾ç½®å’Œè¯»å–NSMutableURLRequestçš„å±æ€§.åˆ›å»ºä¸€ä¸ªæ•°ç»„å¯¹è±¡,æ‰¿è½½æ‰€æœ‰éœ€è¦é…ç½®çš„å±æ€§(èœ‚çªæ•°æ®ã€ç¼“å­˜ç­–ç•¥ã€cookieã€ç®¡é“ã€ç½‘ç»œçŠ¶æ€ã€è¶…æ—¶),å¹¶æ‰‹åŠ¨å®ç°KVO,å¯¹ç›¸å…³å‚æ•°å®æ—¶è¿›è¡Œç›‘å¬.

```
    //KVO æ·»åŠ ç›‘å¬
    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) {
        if ([self respondsToSelector:NSSelectorFromString(keyPath)]) {
            [self addObserver:self forKeyPath:keyPath options:NSKeyValueObservingOptionNew context:AFHTTPRequestSerializerObserverContext];
        }
    }
    //setæ–¹æ³•
    - (void)setAllowsCellularAccess:(BOOL)allowsCellularAccess {
    [self willChangeValueForKey:NSStringFromSelector(@selector(allowsCellularAccess))];
    _allowsCellularAccess = allowsCellularAccess;
    [self didChangeValueForKey:NSStringFromSelector(@selector(allowsCellularAccess))];
}
//è‡ªåŠ¨ç›‘å¬,å› ä¸ºä½¿ç”¨çš„æ‰‹åŠ¨KVO,åˆ¤æ–­è‡ªå·±æ‰‹åŠ¨ç›‘å¬çš„è·¯å¾„ è¿”å›NO
+ (BOOL)automaticallyNotifiesObserversForKey:(NSString *)key {
    if ([AFHTTPRequestSerializerObservedKeyPaths() containsObject:key]) {
        return NO;
    }

    return [super automaticallyNotifiesObserversForKey:key];
}

- (void)observeValueForKeyPath:(NSString *)keyPath
                      ofObject:(__unused id)object
                        change:(NSDictionary *)change
                       context:(void *)context
{
    if (context == AFHTTPRequestSerializerObserverContext) {
        if ([change[NSKeyValueChangeNewKey] isEqual:[NSNull null]]) {
            [self.mutableObservedChangedKeyPaths removeObject:keyPath];
        } else {
            [self.mutableObservedChangedKeyPaths addObject:keyPath];
        }
    }
}
```
å°†å‘ç”Ÿæ”¹å˜çš„keyPathè£…å…¥åˆ°é›†åˆä¸­,åœ¨æ„å»ºRequestå¯¹è±¡çš„æ—¶å€™,å–å‡ºå¯¹åº”çš„å€¼è¿›è¡Œèµ‹å€¼

```
    NSMutableURLRequest *mutableRequest = [[NSMutableURLRequest alloc] initWithURL:url];
    mutableRequest.HTTPMethod = method;
    
    //ç»™NSMutableURLRequestè‡ªå¸¦çš„å±æ€§èµ‹å€¼ NSURLRequest/NSMutableURLRequestéœ€è¦èµ‹å€¼çš„å±æ€§å¯ä»¥åœ¨AFHTTPRequestSerializerObservedKeyPaths()ä¸­æ‰¾åˆ°
    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) {
//        é€šè¿‡åˆ¤æ–­mutableObservedChangedKeyPathsï¼ˆNSMutableSetï¼‰ä¸­æ˜¯å¦æœ‰è¿™ä¸ªkeyPathï¼Œæ¥è®¾å®šmutableRequestå¯¹åº”çš„keyPathå€¼ã€‚
        if ([self.mutableObservedChangedKeyPaths containsObject:keyPath]) {
            [mutableRequest setValue:[self valueForKeyPath:keyPath] forKey:keyPath];
        }
    }
```


##ç™¾åˆ†æ¯”ç¼–ç |URLè½¬ä¹‰
RFC3986æ–‡æ¡£è§„å®šï¼ŒURLä¸­åªå…è®¸åŒ…å«è‹±æ–‡å­—æ¯ï¼ˆa-zA-Zï¼‰ã€æ•°å­—ï¼ˆ0-9ï¼‰ã€-_.~4ä¸ªç‰¹æ®Šå­—ç¬¦ä»¥åŠæ‰€æœ‰ä¿ç•™å­—ç¬¦.æ‰€ä»¥å¯¹äºä¸€äº›ç‰¹æ®Šå­—ç¬¦,æ¯”å¦‚ç©ºæ ¼,æ±‰å­—,ç­‰éœ€è¦è¿›è¡Œè½¬ä¹‰,ä»¥é¿å…é€ æˆæ¥æ”¶URLçš„æœåŠ¡å™¨è§£æé”™è¯¯.
æ¯ä¸€ä¸ªéASCIIå­—ç¬¦éƒ½ä¼šè¢«æ›¿æ¢æˆâ€%XXâ€çš„å½¢å¼ï¼ŒXXä¸ºä¸¤ä½16è¿›åˆ¶æ•°ï¼Œå¯¹åº”è¯¥å­—ç¬¦åœ¨iso-8859-1å­—ç¬¦é›†é‡Œé¢çš„ç¼–ç ã€‚è¿™ä¸ªè¿‡ç¨‹å³URLè½¬è®®ï¼Œæˆ–è€…å«ç™¾åˆ†æ¯”ç¼–ç 

æ ¸å¿ƒä»£ç 

```
NSString * AFPercentEscapedStringFromString(NSString *string) {
     //ä¸åŒ…å« ? / éœ€è¦åšç™¾åˆ†æ¯”ç¼–ç å¤„ç†çš„å­—ç¬¦ä¸²é›†åˆ
    static NSString * const kAFCharactersGeneralDelimitersToEncode = @":#[]@"; // does not include "?" or "/" due to RFC 3986 - Section 3.4
    static NSString * const kAFCharactersSubDelimitersToEncode = @"!$&'()*+,;=";
     
     //è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥,URLQueryAllowedCharacterSetæ˜¯ä¸€ä¸ªURLå…è®¸çš„å­—ç¬¦é›†åˆ,ç„¶åä»è¿™ä¸ªé›†åˆä¸­ç§»é™¤,å³è¿™ä¸ªé›†åˆä¹‹å¤–çš„éƒ½éœ€è¦è¿›è¡Œç¼–ç 
    NSMutableCharacterSet * allowedCharacterSet = [[NSCharacterSet URLQueryAllowedCharacterSet] mutableCopy];
    [allowedCharacterSet removeCharactersInString:[kAFCharactersGeneralDelimitersToEncode stringByAppendingString:kAFCharactersSubDelimitersToEncode]];
     
     //ä»¥50ä¸ºåŸºå‡†è¿›è¡Œåˆ†å‰²
    static NSUInteger const batchSize = 50;

    NSUInteger index = 0;
    NSMutableString *escaped = @"".mutableCopy;
     
    while (index < string.length) {
        
        NSUInteger length = MIN(string.length - index, batchSize);
        NSRange range = NSMakeRange(index, length);

        // To avoid breaking up character sequences such as ğŸ‘´ğŸ»ğŸ‘®ğŸ½
        //æˆªå–èŒƒå›´å†…çš„å­—ç¬¦,é¿å…è¡¨æƒ…(lenth = 2)çš„å­—ç¬¦å‘ç”Ÿæˆªå–é”™è¯¯
        range = [string rangeOfComposedCharacterSequencesForRange:range];

        NSString *substring = [string substringWithRange:range];
        //ç™¾åˆ†æ¯”ç¼–ç 
        NSString *encoded = [substring stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];
        [escaped appendString:encoded];

        index += range.length;
    }
	return escaped;
}
```
AFHTTPRequestSerializeréµå¾ªAFURLRequestSerializationåè®®,è¯¥åè®®å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•,ç”¨äºé€šè¿‡ä¼ å…¥çš„å‚æ•°å¯¹URLè¿›è¡Œåºåˆ—åŒ–.

```
- (nullable NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request
                               withParameters:(nullable id)parameters
                                        error:(NSError * _Nullable __autoreleasing *)error
```
å†…éƒ¨çš„å®ç°æœºåˆ¶,ä¸»è¦ä¸ºè®¾ç½®è¯·æ±‚å¤´,å¯¹è¯·æ±‚å‚æ•°æ’åºå¹¶è¿›è¡Œç™¾åˆ†æ¯”ç¼–ç .ä¸åŒçš„è¯·æ±‚æ–¹å¼åˆ†åˆ«è¿›è¡Œæ‹¼æ¥.(HTTPHeader,HTTPBody),å­ç±»å¯¹è±¡ä¹Ÿå¯ä»¥é‡å†™è¯¥æ–¹æ³•,å®ç°è‡ªå·±çš„é€»è¾‘.æ¯”å¦‚AFPropertyListRequestSerializer,AFJSONRequestSerializer

æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨AFNetworkingéƒ½æ˜¯ä½¿ç”¨çš„å­—å…¸æ¥æ‰¿è½½éœ€è¦ä¼ å…¥çš„è¯·æ±‚å‚æ•°,å†…éƒ¨é€šè¿‡è¿­ä»£å’Œé€’å½’(å‚æ•°çš„å€¼ä¹Ÿæœ‰å¯èƒ½æ˜¯é›†åˆç±»å‹çš„å‚æ•°)æ¥æ„å»ºç§æœ‰å¯¹è±¡AFQueryStringPair,æ¥åˆ†åˆ«å¯¹åº”keyå’Œvalue.å¹¶è°ƒç”¨` - (NSString *)URLEncodedStringValue `å®ä¾‹æ–¹æ³•æ¥è¿›è¡Œç™¾åˆ†æ¯”ç¼–ç .

```
//æŠŠç±»å‹ä¸ºNSDictionaryçš„å‚æ•°å¤„ç†ä¸ºå­—ç¬¦ä¸²(ä¸­é—´è¿›è¡Œç¼–ç ,æ’åº)ç±»å‹ã€‚
NSString * AFQueryStringFromParameters(NSDictionary *parameters) {
    NSMutableArray *mutablePairs = [NSMutableArray array];
    //éå†å¾—åˆ°ä¸€ä¸ª(key=value)ç±»å‹çš„å­—ç¬¦ä¸²,æ·»åŠ åˆ°æ•°ç»„ä¸­
    for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) {
        [mutablePairs addObject:[pair URLEncodedStringValue]];
    }
    //æ ¹æ®è¿æ¥ç¬¦&æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²
    return [mutablePairs componentsJoinedByString:@"&"];
}

NSArray * AFQueryStringPairsFromDictionary(NSDictionary *dictionary) {
    return AFQueryStringPairsFromKeyAndValue(nil, dictionary);
}

//æ•°ç»„ä¸­åŒ…å«AFQueryStringPair(å‚æ•°å­—ç¬¦ä¸²å¯¹)å¯¹è±¡
NSArray * AFQueryStringPairsFromKeyAndValue(NSString *key, id value) {
    NSMutableArray *mutableQueryStringComponents = [NSMutableArray array];
    
    //æ’åº,å‡åº
    NSSortDescriptor *sortDescriptor = [NSSortDescriptor sortDescriptorWithKey:@"description" ascending:YES selector:@selector(compare:)];

    if ([value isKindOfClass:[NSDictionary class]]) {
        NSDictionary *dictionary = value;
        //å¯¹å­—å…¸çš„é”®è¿›è¡Œæ’åºä»¥ä¿è¯å…¶è¿ç»­æ€§,å½“è¿›è¡ŒæŸ¥è¯¢æ“ä½œçš„æ—¶å€™,è¿™å¯¹äºååºåˆ—åŒ–å¯èƒ½æ¨¡ç³Šçš„åºåˆ—(æ¯”å¦‚å­—å…¸æ•°ç»„)æ˜¯éå¸¸é‡è¦çš„.
        for (id nestedKey in [dictionary.allKeys sortedArrayUsingDescriptors:@[ sortDescriptor ]]) {
            id nestedValue = dictionary[nestedKey];
            if (nestedValue) {
                //é€’å½’è°ƒç”¨,æ¯”å¦‚valueæ˜¯å­—å…¸,æˆ–è€…å…¶ä»–é›†åˆç±»å‹
                [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue((key ? [NSString stringWithFormat:@"%@[%@]", key, nestedKey] : nestedKey), nestedValue)];
            }
        }
    } else if ([value isKindOfClass:[NSArray class]]) {
        NSArray *array = value;
        for (id nestedValue in array) {
            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue([NSString stringWithFormat:@"%@[]", key], nestedValue)];
        }
    } else if ([value isKindOfClass:[NSSet class]]) {
        NSSet *set = value;
        //é›†åˆæ˜¯æ— åºçš„
        for (id obj in [set sortedArrayUsingDescriptors:@[ sortDescriptor ]]) {
            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue(key, obj)];
        }
    } else {
        //ç›´æ¥è¿›è¡Œå®ä¾‹åŒ–,æ·»åŠ åˆ°æ•°ç»„ä¸­
        [mutableQueryStringComponents addObject:[[AFQueryStringPair alloc] initWithField:key value:value]];
    }

    return mutableQueryStringComponents;
}
```

AFQueryStringPairçš„å®ä¾‹æ–¹æ³•

```
//æŠŠå·¦å³çš„æ•°æ®(key=value)ä½¿ç”¨AFPercentEscapedStringFromStringå‡½æ•°è¿›è¡Œç™¾åˆ†æ¯”ç¼–ç ç„¶åç”¨=æ‹¼æ¥èµ·æ¥ã€‚
- (NSString *)URLEncodedStringValue {
    if (!self.value || [self.value isEqual:[NSNull null]]) {
        return AFPercentEscapedStringFromString([self.field description]);
    } else {
        return [NSString stringWithFormat:@"%@=%@", AFPercentEscapedStringFromString([self.field description]), AFPercentEscapedStringFromString([self.value description])];
    }
}
```

##æ ¹æ®ä¸åŒçš„è¯·æ±‚æ–¹å¼æ ¼å¼åŒ–è¯·æ±‚å‚æ•°
HTTPMethodsEncodingParametersInURIè¿™ä¸ªé›†åˆè¡¨ç¤ºéœ€è¦å°†å‚æ•°æ‹¼æ¥åˆ°URLä¸Šçš„è¯·æ±‚æ–¹å¼,é»˜è®¤åŒ…å«GET HEAD DELETE,ä¸åœ¨è¿™ä¸ªé›†åˆå¤–çš„è¯·æ±‚methodå°†å‚æ•°è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ•°æ®,æ”¾å…¥åˆ°HTTPBodyä¸­.

```
    //GET HEAD DELETE æ‹¼æ¥åœ¨URLä¸­
    if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) {
        if (query && query.length > 0) {
            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? @"&%@" : @"?%@", query]];
        }
    } else {
        // #2864: an empty string is a valid x-www-form-urlencoded payload
        if (!query) {
            //ç©ºå­—ç¬¦ä¸²
            query = @"";
        }
        //content-Type
        if (![mutableRequest valueForHTTPHeaderField:@"Content-Type"]) {
            [mutableRequest setValue:@"application/x-www-form-urlencoded" forHTTPHeaderField:@"Content-Type"];
        }
        //è¯·æ±‚ä½“
        [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];
    }
    
```
Accept-Language å¯æ¥å—çš„è¯­è¨€

```
    //Accept-Language å¯æ¥å—çš„è¯­è¨€ qè¡¨ç¤ºæƒé‡
    NSMutableArray *acceptLanguagesComponents = [NSMutableArray array];
    [[NSLocale preferredLanguages] enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) {
        float q = 1.0f - (idx * 0.1f);
        [acceptLanguagesComponents addObject:[NSString stringWithFormat:@"%@;q=%0.1g", obj, q]];
        *stop = q <= 0.5f;
    }];
    [self setValue:[acceptLanguagesComponents componentsJoinedByString:@", "] forHTTPHeaderField:@"Accept-Language"];
```

User-Agent å‘å‡ºè¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯

```
    NSString *userAgent = nil;
#if TARGET_OS_IOS
    //iOS
    // User-Agent Header; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.43
    userAgent = [NSString stringWithFormat:@"%@/%@ (%@; iOS %@; Scale/%0.2f)",
                 [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleExecutableKey] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleIdentifierKey],//ExecutableKeyæˆ–è€…BundleID
                 [[NSBundle mainBundle] infoDictionary][@"CFBundleShortVersionString"] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleVersionKey], //appç‰ˆæœ¬
                 [[UIDevice currentDevice] model], //@"iPhone", @"iPod touch"
                 [[UIDevice currentDevice] systemVersion], //ç³»ç»Ÿç‰ˆæœ¬
                 [[UIScreen mainScreen] scale]];//å±å¹•scale
  [self setValue:userAgent forHTTPHeaderField:@"User-Agent"];

```

Authorization	HTTPæˆæƒçš„æˆæƒè¯ä¹¦	
ç¤ºä¾‹: Authorization:Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==
```
//HTTPæˆæƒçš„æˆæƒè¯ä¹¦    Authorization:Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==
- (void)setAuthorizationHeaderFieldWithUsername:(NSString *)username
                                       password:(NSString *)password
{
    NSData *basicAuthCredentials = [[NSString stringWithFormat:@"%@:%@", username, password] dataUsingEncoding:NSUTF8StringEncoding];
    //Base64ç¼–ç 
    NSString *base64AuthCredentials = [basicAuthCredentials base64EncodedStringWithOptions:(NSDataBase64EncodingOptions)0];
    [self setValue:[NSString stringWithFormat:@"Basic %@", base64AuthCredentials] forHTTPHeaderField:@"Authorization"];
}

- (void)clearAuthorizationHeader {
    dispatch_barrier_async(self.requestHeaderModificationQueue, ^{
        [self.mutableHTTPRequestHeaders removeObjectForKey:@"Authorization"];
    });
}
```

##multipart/from-data
####ä»€ä¹ˆæ˜¯multipart/from-data
æ ¹æ®æ ‡å‡†çš„httpåè®®ï¼Œæˆ‘ä»¬çš„è¯·æ±‚åªèƒ½æ˜¯OPTIONS, GET, HEAD, POST, PUT, DELETE, TRACEè¿™å‡ ç§ã€‚httpåè®®æ˜¯ä»¥ASCIIç ä¼ è¾“ï¼Œå»ºç«‹åœ¨tcp, ipåè®®ä¹‹ä¸Šçš„åº”ç”¨å±‚è§„èŒƒï¼Œhttpè¯·æ±‚è¢«åˆ†ä¸ºäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼šçŠ¶æ€è¡Œã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ã€‚
å®é™…ä¸Šï¼ŒåŸå§‹çš„httpè¯·æ±‚æ˜¯ä¸æ”¯æŒä»€ä¹ˆmultipartæˆ–è€…www-form-urlencodedçš„ï¼Œè€Œæ‰€æœ‰çš„è¿™äº›ç±»å‹ï¼Œå®é™…ä¸Šæ˜¯å¯¹httpè¯·æ±‚ä½“çš„ä¸€æ¬¡å°è£…ã€‚
å¦‚ä¸‹:

1. multipart/form-dataçš„åŸºç¡€æ–¹æ³•æ˜¯postï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯ç”±postæ–¹æ³•æ¥ç»„åˆå®ç°çš„.
2. multipart/form-dataä¸postæ–¹æ³•çš„ä¸åŒä¹‹å¤„ï¼šè¯·æ±‚å¤´ï¼Œè¯·æ±‚ä½“ã€‚
3. multipart/form-dataçš„è¯·æ±‚å¤´å¿…é¡»åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„å¤´ä¿¡æ¯ï¼šContent-Typeï¼Œä¸”å…¶å€¼ä¹Ÿå¿…é¡»è§„å®šä¸ºmultipart/form-dataï¼ŒåŒæ—¶è¿˜éœ€è¦è§„å®šä¸€ä¸ªå†…å®¹åˆ†å‰²ç¬¦ç”¨äºåˆ†å‰²è¯·æ±‚ä½“ä¸­çš„å¤šä¸ªpostçš„å†…å®¹ï¼Œå¦‚æ–‡ä»¶å†…å®¹å’Œæ–‡æœ¬å†…å®¹è‡ªç„¶éœ€è¦åˆ†å‰²å¼€æ¥ï¼Œå¦åˆ™æœåŠ¡å™¨å°±æ— æ³•æ­£å¸¸è§£æå’Œè¿˜åŸè¿™ä¸ªæ–‡ä»¶.

```
//${bound} æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œä»£è¡¨æˆ‘ä»¬è§„å®šçš„åˆ†å‰²ç¬¦ï¼Œå¯ä»¥è‡ªå·±ä»»æ„è§„å®šï¼Œä½†ä¸ºäº†é¿å…å’Œæ­£å¸¸æ–‡æœ¬é‡å¤äº†ï¼Œå°½é‡è¦ä½¿ç”¨å¤æ‚ä¸€ç‚¹çš„å†…å®¹ã€‚å¦‚AFNetWorking:[NSString stringWithFormat:@"Boundary+%08X%08X", arc4random(), arc4random()];
Content-Type: multipart/form-data; boundary=${bound}

```

multipart/form-dataçš„è¯·æ±‚ä½“ä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸è¿‡å’Œpostçš„è¯·æ±‚ä½“ä¸åŒçš„æ˜¯å®ƒçš„æ„é€ æ–¹å¼ï¼Œpostæ˜¯ç®€å•çš„name=valueå€¼è¿æ¥ï¼Œè€Œmultipart/form-dataåˆ™æ˜¯æ·»åŠ äº†åˆ†éš”ç¬¦ç­‰å†…å®¹çš„æ„é€ ä½“

```
Header = {"Content-type" : "multipart/form-data, boundary=AaB03x"}  
  
Data =  "--AaB03x\r\n" +  
        "content-disposition: form-data; name=\"field1\"\r\n" +  
        "\r\n" +   
        "Joe Blow\r\n" +  
        "--AaB03x\r\n" +  
        "content-disposition: form-data; name="pics"; filename=\"file1.txt\"\r\n" +  
        "Content-Type: text/plain\r\n" +  
        "\r\n" +  
        "" ... contents of file1.txt ...\r\n" +  
        "--AaB03x--\r\n" 
```

AFHTTPæ„å»ºmultipart/form-dataçš„æ–¹å¼:

```
 //è¯·æ±‚å¤´å‚æ•°
    NSDictionary *dic = @{
                          @"businessType":@"CC_USER_CENTER",
                          @"fileType":@"image",
                          @"file":@"img.png"
                          };
    //è¯·æ±‚ä½“å›¾ç‰‡æ•°æ®
    NSData *imageData = UIImagePNGRepresentation([UIImage imageNamed:@"1.png"]);
    //åˆ›å»ºrequest
    NSMutableURLRequest *request = [[NSMutableURLRequest alloc]initWithURL:[NSURL URLWithString:url]];
    //postæ–¹æ³•
    [request setHTTPMethod:@"POST"];
    
    AFHTTPSessionManager *manager = [[AFHTTPSessionManager alloc]initWithSessionConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration]];
    NSURLSessionDataTask *task = [manager POST:url parameters:dic constructingBodyWithBlock:^(id<AFMultipartFormData>  _Nonnull formData) {
        //è¯·æ±‚ä½“é‡Œé¢çš„å‚æ•°
        [formData appendPartWithFileData:imageData name:@"file" fileName:@"image.png" mimeType:@"image/png"];
//        NSDictionary *bodyDic = @{
//                                  @"Content-Disposition":@"form-data;name=\"file\";filename=\"img.png\"",
//                                  @"Content-Type":@"image/png",
//                                  };
//        [formData appendPartWithHeaders:bodyDic body:imageData];
    } progress:^(NSProgress * _Nonnull uploadProgress) {
        NSLog(@"ä¸Šä¼ è¿›åº¦");
    } success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
        NSLog(@"ä¸Šä¼ æˆåŠŸ:%@",responseObject);
    } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
        NSLog(@"ä¸Šä¼ å¤±è´¥%@",error);
    }];
    [task resume];
    
```
AFStreamingMultipartFormDataå¯¹è±¡,ç”¨äºæ„å»ºNSMutableURLRequestçš„HTTPBodyStream.è¯¥å¯¹è±¡éµå¾ªAFMultipartFormDataåè®®,é€šè¿‡Blockå›è°ƒ,è°ƒç”¨ç›¸å…³ä»£ç†æ–¹æ³•,è®©æˆ‘ä»¬å¯ä»¥è¿›è¡Œæ·»åŠ æ•°æ®æµ(é€šè¿‡NSData,æ–‡ä»¶è·¯å¾„,NSInputStream)å’Œè®¾ç½®è¯·æ±‚å¤´(Content-Type,Content-Length)

```
- (NSMutableURLRequest *)multipartFormRequestWithMethod:(NSString *)method
                                              URLString:(NSString *)URLString
                                             parameters:(NSDictionary *)parameters
                              constructingBodyWithBlock:(void (^)(id <AFMultipartFormData> formData))block
                                                  error:(NSError *__autoreleasing *)error
{
    NSParameterAssert(method);
    NSParameterAssert(![method isEqualToString:@"GET"] && ![method isEqualToString:@"HEAD"]);
    /*
     å…ˆæ„å»ºä¸€ä¸ªæ™®é€šçš„requestå¯¹è±¡ï¼Œç„¶ååœ¨æ„å»ºå‡ºmultipartFromçš„request
     * åœ¨è¿™ä¸€æ­¥å°†ä¼šæŠŠparametersåŠ å…¥è¯·æ±‚å¤´æˆ–è€…è¯·æ±‚ä½“ã€‚ç„¶åæŠŠ`AFURLRequestSerialization`æŒ‡å®šçš„headersåŠ å…¥requestçš„è¯·æ±‚å¤´ä¸­ã€‚è¿™ä¸ªrequestå°±åªå·®æ„å»ºmultipartFroméƒ¨åˆ†äº†
     */
    NSMutableURLRequest *mutableRequest = [self requestWithMethod:method URLString:URLString parameters:nil error:error];
    /*
     *åˆå§‹åŒ–ä¸€ä¸ª`AFStreamingMultipartFormData`å¯¹è±¡ã€‚ç”¨äºå°è£…multipartFromçš„bodyéƒ¨åˆ†
     */
    __block AFStreamingMultipartFormData *formData = [[AFStreamingMultipartFormData alloc] initWithURLRequest:mutableRequest stringEncoding:NSUTF8StringEncoding];
    if (parameters) {
        /*
         æŠŠparametersæ‹¼æ¥æˆ`AFQueryStringPair`å¯¹è±¡ã€‚ç„¶åæ ¹æ®å–å‡ºçš„keyå’Œvalueå¤„ç†ã€‚
         */
        for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) {
            NSData *data = nil;
            //æŠŠvalueå¤„ç†ä¸ºNSDataç±»å‹
            if ([pair.value isKindOfClass:[NSData class]]) {
                data = pair.value;
            } else if ([pair.value isEqual:[NSNull null]]) {
                data = [NSData data];
            } else {
                data = [[pair.value description] dataUsingEncoding:self.stringEncoding];
            }
            if (data) {
                [formData appendPartWithFormData:data name:[pair.field description]];
            }
        }
    }
    if (block) {
        block(formData);
    }
    //bodyå…·ä½“åºåˆ—åŒ–æ“ä½œ
    return [formData requestByFinalizingMultipartFormData];
}
- (NSMutableURLRequest *)requestByFinalizingMultipartFormData {
    if ([self.bodyStream isEmpty]) {
        return self.request;
    }
    // Reset the initial and final boundaries to ensure correct Content-Length
    //é‡ç½®boundaryï¼Œä»è€Œç¡®ä¿`Content-Length`æ­£ç¡®
    [self.bodyStream setInitialAndFinalBoundaries];
    //æŠŠæ‹¼æ¥å¥½çš„bodyStreamæ·»åŠ è¿›å…¥requestä¸­
    [self.request setHTTPBodyStream:self.bodyStream];
    //ç»™requstçš„è¯·æ±‚å¤´æ·»åŠ Content-Typeå±æ€§æŒ‡å®šä¸º`multipart/form-data`ç±»å‹çš„requestã€‚åŒæ—¶è®¾ç½®è¯·æ±‚ä½“çš„é•¿åº¦Content-Lengthã€‚
    [self.request setValue:[NSString stringWithFormat:@"multipart/form-data; boundary=%@", self.boundary] forHTTPHeaderField:@"Content-Type"];
    [self.request setValue:[NSString stringWithFormat:@"%llu", [self.bodyStream contentLength]] forHTTPHeaderField:@"Content-Length"];
    
    return self.request;
}
```
AFStreamingMultipartFormDataæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡AFMultipartBodyStream,è¯¥ç±»å°±å¥½åƒä¸€ä¸ªç®¡é“,æ‰¿è½½ä¸€ä¸ªä¸ªçš„AFHTTPBodyPartå¯¹è±¡,åƒè¯»å–æ•°æ®æµä¸€æ ·,æ·»åŠ è¯·æ±‚ä½“çš„ä¸€æ®µæ®µå†…å®¹.

```
//å¯¹äºNSInputStreamçš„ä½¿ç”¨æ¥è¯´ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨å®ç°æ–¹æ³•,å½“æˆ‘ä»¬ä½¿ç”¨openæ‰“å¼€æµçš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å¤„ç†æˆ‘ä»¬çš„é€»è¾‘ã€‚
- (NSInteger)read:(uint8_t *)buffer
        maxLength:(NSUInteger)length
{
    NSInteger totalNumberOfBytesRead = 0;
    
    //åˆå§‹è¾¹ç•Œ
    if (_phase == AFEncapsulationBoundaryPhase) {
        NSData *encapsulationBoundaryData = [([self hasInitialBoundary] ? AFMultipartFormInitialBoundary(self.boundary) : AFMultipartFormEncapsulationBoundary(self.boundary)) dataUsingEncoding:self.stringEncoding];
        totalNumberOfBytesRead += [self readData:encapsulationBoundaryData intoBuffer:&buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)totalNumberOfBytesRead)];
    }
    
    //å¤´
    if (_phase == AFHeaderPhase) {
        NSData *headersData = [[self stringForHeaders] dataUsingEncoding:self.stringEncoding];
        totalNumberOfBytesRead += [self readData:headersData intoBuffer:&buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)totalNumberOfBytesRead)];
    }
    
    //body
    if (_phase == AFBodyPhase) {
        NSInteger numberOfBytesRead = 0;

        numberOfBytesRead = [self.inputStream read:&buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)totalNumberOfBytesRead)];
        if (numberOfBytesRead == -1) {
            return -1;
        } else {
            totalNumberOfBytesRead += numberOfBytesRead;

            if ([self.inputStream streamStatus] >= NSStreamStatusAtEnd) {
                [self transitionToNextPhase];
            }
        }
    }
    
    //ç»“æŸè¾¹ç•Œ
    if (_phase == AFFinalBoundaryPhase) {
        NSData *closingBoundaryData = ([self hasFinalBoundary] ? [AFMultipartFormFinalBoundary(self.boundary) dataUsingEncoding:self.stringEncoding] : [NSData data]);
        totalNumberOfBytesRead += [self readData:closingBoundaryData intoBuffer:&buffer[totalNumberOfBytesRead] maxLength:(length - (NSUInteger)totalNumberOfBytesRead)];
    }

    return totalNumberOfBytesRead;
}
```
æˆ‘ä»¬å¯ä»¥é€šè¿‡NSURLSesstionæ¥æ„å»ºä¸€ä¸ªmultipart/from-dataè¯·æ±‚æ¥ç±»æ¯”ä¸€ä¸‹:

```
//å‚æ•°
    NSDictionary *dic = @{
                          @"businessType":@"CC_USER_CENTER",
                          @"fileType":@"image",
                          @"file":@"img.jpeg"
                          };
    //åˆ†éš”ç¬¦
    NSString *boundaryString = [NSString stringWithFormat:@"Boundary+%08X%08X", arc4random(), arc4random()];
    NSMutableString *str = [NSMutableString string];
    //è¯·æ±‚å‚æ•°
    [dic enumerateKeysAndObjectsUsingBlock:^(id  _Nonnull key, id  _Nonnull obj, BOOL * _Nonnull stop) {
        [str appendFormat:@"--%@\r\n",boundaryString];
        [str appendFormat:@"%@name=\"%@\"\r\n\r\n",@"Content-Disposition: form-data;",key];
        [str appendFormat:@"%@\r\n",obj];
    }];
    
    NSMutableData *requestMutableData=[NSMutableData data];
    
    //åˆ†éš”ç¬¦
    [str appendFormat:@"--%@\r\n",boundaryString];
    //å¤´
    [str appendFormat:@"%@:%@",@"Content-Disposition",@"form-data;"];
    [str appendFormat:@"%@=\"%@\";",@"name",@"file"];
    [str appendFormat:@"%@=\"%@\"\r\n",@"filename",@"img1.jpeg"];
    [str appendFormat:@"%@:%@\r\n\r\n",@"Content-Type",@"image/png"];
    //è½¬æ¢æˆä¸ºäºŒè¿›åˆ¶æ•°æ® (ä¸»ä½“)
    [requestMutableData appendData:[str dataUsingEncoding:NSUTF8StringEncoding]];
    NSData *imageData = UIImagePNGRepresentation([UIImage imageNamed:@"1.png"]);
    //æ–‡ä»¶æ•°æ®éƒ¨åˆ†
    [requestMutableData appendData:imageData];
    //æ·»åŠ ç»“å°¾boundary (ç»“æŸè¾¹ç•Œ)
    [requestMutableData appendData:[[NSString stringWithFormat:@"\r\n--%@--\r\n",boundaryString] dataUsingEncoding:NSUTF8StringEncoding]];

    NSLog(@"%@",[[NSString alloc]initWithData:requestMutableData encoding:NSUTF8StringEncoding]);
    NSMutableURLRequest *request = [[NSMutableURLRequest alloc]initWithURL:[NSURL URLWithString:url]];
    //postæ–¹æ³•
    [request setHTTPMethod:@"POST"];
    // è®¾ç½®è¯·æ±‚å¤´æ ¼å¼ä¸ºContent-Type:multipart/form-data; boundary=xxxxx
    [request setValue:[NSString stringWithFormat:@"multipart/form-data; boundary=%@",boundaryString] forHTTPHeaderField:@"Content-Type"];
    request.HTTPBody = requestMutableData;
    
    NSURLSession *session = [NSURLSession sessionWithConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration]];
    NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
        NSString *result = [[NSString alloc]initWithData:data encoding:NSUTF8StringEncoding];
        NSLog(@"%@",result);
    }];
    
    [task resume];
    ```
    