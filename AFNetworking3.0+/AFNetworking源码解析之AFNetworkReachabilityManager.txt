#AFNetworkingæºç è§£æä¹‹AFNetworkReachabilityManager

![](http://upload-images.jianshu.io/upload_images/1217241-82deec99fe5e6fdb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

##ç®€ä»‹
AFNetworkReachabilityManageré€šè¿‡åŸŸåæˆ–è€…ä¸€ä¸ªåœ°å€æ¥ç›‘æ§è®¾å¤‡çš„ç½‘ç»œçŠ¶æ€,å› ä¸ºä¸šåŠ¡åŠŸèƒ½ç›¸å¯¹å•ä¸€,è§£æèµ·æ¥ä¹Ÿç›¸å¯¹å®¹æ˜“äº›,ä¸»è¦æ¶‰åŠSCNetworkReachabilityRefçš„å†…å®¹.

##åº”ç”¨åœºæ™¯
æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªç±»æ¥å®æ—¶ç›‘å¬è®¾å¤‡çš„ç½‘ç»œæƒ…å†µ,è¾ƒå·®(NotReachable)çš„æ—¶å€™,æç¤ºç”¨æˆ·åšç›¸åº”çš„æ£€æŸ¥,ä»¥æ­¤æé«˜ç”¨æˆ·ä½“éªŒ.æˆ–è€…è§†é¢‘ç±»/éœ€è¦å¤§é‡æ¶ˆè€—æµé‡çš„Appä¸­,ç›‘æ§ç½‘ç»œçŠ¶æ€,å¦‚æœå½“å‰æ˜¯WWAN(2G/3G/4G)æ—¶,é€šè¿‡å¼€å…³æ¥ç”¨æˆ·é€‰æ‹©æ˜¯å¦é€šè¿‡WWANç½‘ç»œæ¥è§‚çœ‹è§†é¢‘æˆ–è€…ä¸‹è½½æ–‡ä»¶,å¦‚æœç”¨æˆ·ä¸å…è®¸2G/3G/4Gç½‘ç»œè§‚çœ‹è§†é¢‘æˆ–è€…ä¸‹è½½æ–‡ä»¶ï¼Œè€Œæ­¤æ—¶æ‰‹æœºç½‘ç»œåˆæ˜¯2G/3G/4Gç½‘ç»œ,æç¤ºç”¨æˆ·å½“å‰ç½‘ç»œä¸æ”¯æŒæ’­æ”¾è§†é¢‘å’Œä¸‹è½½ã€‚ä»¥é¿å…ä¸å¿…è¦æ¶ˆè€—è¿‡å¤šçš„æµé‡,å¸¦æ¥çš„ç»æµæŸå¤±å’Œå¯¹Appçš„æ»¡æ„åº¦.

##ä½¿ç”¨æ–¹æ³•
1. é€šè¿‡Block

```
- (IBAction)start1:(id)sender {
    self.manager = [AFNetworkReachabilityManager managerForDomain:@"https://www.baidu.com"];
    [self.manager setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) {
        switch (status) {
                //æœªçŸ¥
            case AFNetworkReachabilityStatusUnknown:
                NSLog(@"ä½ æ˜¯å¤–æ˜ŸäººğŸ‘½å—?");
                break;
                //ç½‘ç»œä¸å¯è¾¾
            case AFNetworkReachabilityStatusNotReachable:
                NSLog(@"åŒ…ç§Ÿå©†,æ–­ç½‘å•¦~");
                break;
                //æ‰‹æœºç½‘ç»œ
            case AFNetworkReachabilityStatusReachableViaWWAN:
                NSLog(@"åœŸè±ª,æˆ‘çš„å†°æ·‡æ·‹å¥—é¤ğŸ˜†!");
                break;
                //WIFI
            case AFNetworkReachabilityStatusReachableViaWiFi:
                NSLog(@"å¸…å“¥,ä½ å®¶WIFIå¯†ç æ˜¯ä»€ä¹ˆ!");
                break;
        }
    }];
    [self.manager startMonitoring];
}

```
2.é€šè¿‡é€šçŸ¥,æ³¨å†Œä¸€ä¸ªnameä¸ºAFNetworkingReachabilityDidChangeNotificationçš„é€šçŸ¥,é€šè¿‡key:AFNetworkingReachabilityNotificationStatusItemå–å‡ºå¯¹åº”çš„ç½‘ç»œçŠ¶æ€

```
    [[NSNotificationCenter defaultCenter]addObserver:self selector:@selector(networkChanged:) name:AFNetworkingReachabilityDidChangeNotification object:nil];
    - (void)networkChanged:(NSNotification *)notification{
    NSString *status = [notification.userInfo objectForKey:AFNetworkingReachabilityNotificationStatusItem];
    NSInteger  statusInt = [status integerValue];
    NSLog(@"%ld",statusInt);
    }
```

##å®ç°åŸç†
ç½‘ç»œç›‘æ§çš„å®ç°æ˜¯ä¾èµ–SystemConfigurationæ¡†æ¶ä¸­çš„SCNetworkReachabilityRef
å¯¼å…¥å¤´æ–‡ä»¶:
`#import <SystemConfiguration/SystemConfiguration.h>`
SCNetworkReachabilityRefæ˜¯ä¸€ä¸ªç»“æ„ä½“

```
     typedef struct {
     // åˆ›å»ºä¸€ä¸ªSCNetworkReachabilityContextç»“æ„ä½“æ—¶ï¼Œéœ€è¦è°ƒç”¨SCDynamicStoreçš„åˆ›å»ºå‡½æ•°ï¼Œè€Œæ­¤åˆ›å»ºå‡½æ•°ä¼šæ ¹æ®versionæ¥åˆ›å»ºå‡ºä¸åŒçš„ç»“æ„ä½“ï¼ŒSCNetworkReachabilityContextå¯¹åº”çš„versionæ˜¯0
     CFIndex        version;
     // ä¸‹é¢ä¸¤ä¸ªblockï¼ˆreleaseå’Œretainï¼‰çš„å‚æ•°å°±æ˜¯infoï¼Œæ­¤å¤„è¡¨ç¤ºçš„æ˜¯ç½‘ç»œçŠ¶æ€å¤„ç†çš„å›è°ƒå‡½æ•°
     void *        __nullable info;
     // è¯¥retain blockç”¨äºå¯¹infoè¿›è¡Œretainï¼Œä¸‹é¢é‚£ä¸ªAFNetworkReachabilityRetainCallbackæ ¸å¿ƒå°±æ˜¯è°ƒç”¨äº†Block_copyï¼ˆç”¨äºretainä¸€ä¸ªblockå‡½æ•°ï¼Œå³åœ¨å †ç©ºé—´æ–°å»ºæˆ–ç›´æ¥å¼•ç”¨ä¸€ä¸ªblockæ‹·è´ï¼‰
     const void    * __nonnull (* __nullable retain)(const void *info);
     // è¯¥release blockç”¨äºå¯¹infoè¿›è¡Œreleaseï¼Œä¸‹é¢é‚£ä¸ªAFNetworkReachabilityReleaseCallbackæ ¸å¿ƒå°±æ˜¯è°ƒç”¨äº†Block_releaseï¼ˆç”¨äºreleaseä¸€ä¸ªblockå‡½æ•°ï¼Œå³å°†blockä»å †ç©ºé—´ç§»é™¤æˆ–ç§»é™¤ç›¸åº”å¼•ç”¨ï¼‰
     void        (* __nullable release)(const void *info);
     // æä¾›infoçš„descriptionï¼Œæ­¤å¤„è°ƒç”¨ä¸ºNULL
     CFStringRef    __nonnull (* __nullable copyDescription)(const void *info);
     } SCNetworkReachabilityContext;
```
æˆ‘ä»¬é€šå¸¸å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹æ³•åˆ›å»ºè¿™ä¸ªå¯¹è±¡

```
SCNetworkReachabilityRef __nullable
SCNetworkReachabilityCreateWithAddress		(
						CFAllocatorRef			__nullable	allocator,
						const struct sockaddr				*address
						)
```

```
SCNetworkReachabilityRef __nullable
SCNetworkReachabilityCreateWithName		(
						CFAllocatorRef			__nullable	allocator,
						const char					*nodename
						)
```
æ ¸å¿ƒä»£ç :

```
//Core Code
- (void)startMonitoring {
    // å…ˆåœæ­¢ä¹‹å‰çš„ç½‘ç»œç›‘å¬
    [self stopMonitoring];
    
    // networkReachabilityè¡¨ç¤ºçš„æ˜¯éœ€è¦æ£€æµ‹çš„ç½‘ç»œåœ°å€çš„å¥æŸ„
    if (!self.networkReachability) {
        return;
    }

    __weak __typeof(self)weakSelf = self;
    // æ ¹æ®ç½‘ç»œçŠ¶æ€statusæ¥è®¾ç½®ç½‘ç»œçŠ¶æ€ç›‘å¬çš„å›è°ƒå‡½æ•°callback
    AFNetworkReachabilityStatusBlock callback = ^(AFNetworkReachabilityStatus status) {
        __strong __typeof(weakSelf)strongSelf = weakSelf;

        strongSelf.networkReachabilityStatus = status;
        if (strongSelf.networkReachabilityStatusBlock) {
            strongSelf.networkReachabilityStatusBlock(status);
        }

    };
       
    //åˆ›å»ºä¸Šä¸‹æ–‡
    SCNetworkReachabilityContext context = {0, (__bridge void *)callback, AFNetworkReachabilityRetainCallback, AFNetworkReachabilityReleaseCallback, NULL};
    
    /**
     // ç»™å®¢æˆ·ç«¯æŒ‡å®šå¯¹åº”targetï¼ˆè¯¥å‚æ•°å’Œéœ€è¦æ£€æµ‹ç½‘ç»œçŠ¶å†µçš„åœ°å€æœ‰ä¸€å®šå…³è”ï¼Œæ­¤å¤„ä½¿ç”¨çš„æ˜¯self.networkReachabilityï¼‰ï¼Œç„¶åå½“è¿™ä¸ªtargetçš„ç½‘ç»œçŠ¶æ€å˜åŒ–æ—¶ï¼Œå‘Šä¹‹SCNetworkReachabilityCallBackå¯¹è±¡calloutå¤„ç†ï¼ˆæ­¤å¤„ä½¿ç”¨çš„æ˜¯AFNetworkReachabilityCallbackï¼‰ï¼Œå¦å¤–calloutä¸­ä½¿ç”¨åˆ°çš„å‚æ•°åŒ…æ‹¬targetå’Œcontextæä¾›çš„infoã€‚
     Boolean
     SCNetworkReachabilitySetCallback    (
     SCNetworkReachabilityRef                                        target,
     SCNetworkReachabilityCallBack    __nullable    callout,
     SCNetworkReachabilityContext    * __nullable    context
     )                __OSX_AVAILABLE_STARTING(__MAC_10_3,__IPHONE_2_0);
     */
    
    //è®¾ç½®å›è°ƒ
    SCNetworkReachabilitySetCallback(self.networkReachability, AFNetworkReachabilityCallback, &context);
    
    /**
     æ­¤å¤„è¡¨ç¤ºåœ¨main RunLoopä¸­ä»¥kCFRunLoopCommonModeså½¢å¼å¤„ç†self.networkingReachability
     */
    //åŠ å…¥RunLoop Main
    SCNetworkReachabilityScheduleWithRunLoop(self.networkReachability, CFRunLoopGetMain(), kCFRunLoopCommonModes);
    
    // åœ¨åå°æ£€æµ‹self.networkingReachabilityçš„ç½‘ç»œçŠ¶æ€ï¼Œå¹¶ä½¿ç”¨SCNetworkReachabilityGetFlagså‡½æ•°è¿”å›äº§ç”Ÿçš„flagï¼Œæ­¤å¤„flagè¡¨ç¤ºçš„å°±æ˜¯ç½‘ç»œçš„çŠ¶æ€
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0),^{
        SCNetworkReachabilityFlags flags;
        if (SCNetworkReachabilityGetFlags(self.networkReachability, &flags)) {
             // AFPostReachabilityStatusChangeå‡½æ•°å°±æ˜¯å…ˆå°†flagsè½¬åŒ–ä¸ºå¯¹åº”çš„AFNetworkReachabilityStatuså˜é‡ï¼Œç„¶åé€šè¿‡Block,é€šçŸ¥å›è°ƒ.
            AFPostReachabilityStatusChange(flags, callback);
        }
    });
}
```